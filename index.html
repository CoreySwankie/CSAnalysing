<!DOCTYPE html>
<html lang="en">
<head>
  <title>CS Analytics</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
  <style>
    /* Set height of the grid so .sidenav can be 100% (adjust as needed) */
    .row.content {height: 550px}

    /* Set gray background color and 100% height */
    .sidenav {
      background-color: #f1f1f1;
      height: 100%;
    }

    /* On small screens, set height to 'auto' for the grid */
    @media screen and (max-width: 767px) {
      .row.content {height: auto;}
    }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="row content">
    <div class="col-sm-3 sidenav hidden-xs">
      <h2>CS Analytics</h2>
      <ul class="nav nav-pills nav-stacked">
        <li class="active"><a href="#home" onclick="ClearPage()">All JSON Info Output</a></li>
        <li><a href="#getdata" onclick="CombineAndSaveData()">Combine and Save Data</a></li>
        <li><a href="#organise" onclick="LoadAndOrganise()">Display Data</a></li>
        <li><a href="#first" onclick="SelectSpecificEventType()">Select Specific Event Type</a></li>
        <li><a href="#clear" onclick="ClearData()">Clear Data Display</a></li>
      </ul><br>
    </div>
    <br>

    <div class="col-sm-9">
        <div class="well">
            <h4>Process {This Tool is still a prototype}</h4>
            <p id="testDisplay"> </p>
        </div>

      <div class="row">
        <div class="col-sm-7">
          <div class="well">
            <h4>Data Display</h4>
            <p id="JSONDisplay"></p>
          </div>
        </div>

        <div class="col-sm-3">
          <div class="well">
            <h4>Sort by</h4>
            <p id="SortButtons"></p>
          </div>
        </div>
      </div>

      <div class = "row">
        <div class="col-sm-5">
          <div class="well">
            <h4>All File Paths</h4>
            <p id="JSONPaths"></p>
            <script type="text/javascript">
            // get the json paths
            $.ajax({
                url: 'getJSONFilePaths.php',
                success: function (response) {//response is value returned from php
                    document.getElementById("JSONPaths").innerHTML = response;
                }
            });
            </script>
          </div>
        </div>


        <!-- unused boxes
        <div class="col-sm-3">
          <div class="well">
            <h4>Sessions</h4>
            <p>10 Million</p>
          </div>
        </div>
        <div class="col-sm-3">
          <div class="well">
            <h4>Bounce</h4>
            <p>30%</p>
          </div>
        </div>
      -->
      </div>

      <!-- unused row
      <div class="row">
        <div class="col-sm-4">
          <div class="well">
            <p>Text</p>
            <p>Text</p>
            <p>Text</p>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="well">
            <p>Text</p>
            <p>Text</p>
            <p>Text</p>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="well">
            <p>Text</p>
            <p>Text</p>
            <p>Text</p>
          </div>
        </div>
      </div>
      -->
      <!-- unused row
      <div class="row">
        <div class="col-sm-8">
          <div class="well">
            <p>Text</p>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="well">
            <p>Text</p>
          </div>
        </div>
      </div>
      -->

    </div>
  </div>
</div>

</body>

<script>

  function SelectSpecificEventType(){
    $.ajax({
        url: 'GetCombinedDataForDisplayManipulation.php',
        success: function (response) {//response is value returned from php
            //document.getElementById("JSONDisplay").innerHTML = response; // output the response, filling the text box with all the json data
            var testDisplayText = "Displaying data from './saved/combinedFile.json'<br/>";
            testDisplayText += "<b>Select an event to see all data of that event type.</b><br/>";
            document.getElementById("testDisplay").innerHTML = testDisplayText;
            document.getElementById("JSONDisplay").innerHTML = ""; // clear the json display

            // parse the responce so we can work with the json data
            var data = JSON.parse(response);
            var dataKeys = [];

            // get the different key names and store in array
            Object.keys(data).forEach(ForEachGetDataKeys);
            function ForEachGetDataKeys(item, index){
              // add the key name to the key array
              dataKeys.push(item);
            }

            // now have all the keys so create some buttons for the event names
            // these buttons will later bring up all the data that relates to that event
            // loop through all the datakeys and create a button for each one.
            dataKeys.forEach(ForEachCreateButton);
            function ForEachCreateButton(item, index){
              CreateButtonForEvent(item);
            }

            // creates a button with the desired event name
            function CreateButtonForEvent(eventName){
              // create a new button
              var newButton = document.createElement("BUTTON");
              var newButtonText = document.createTextNode(eventName);
              // give the button an id incase we need to access via id at any point
              newButton.id = eventName+"_button";
              // append the text to the button
              newButton.appendChild(newButtonText);
              // append the button to the list of buttons
              document.getElementById("testDisplay").appendChild(newButton);

              // add an event listener for clicking on the button to display the data for that event type
              newButton.addEventListener("click", function(){DisplayDataFromEvent(eventName);});
            }

            // create an array of all the event data buttons
            var eventDataButtons = [];

            function DisplayDataFromEvent(eventName){
              //var output = "Button Pressed: " + eventName; // test that the button that is pressed is working correctly, returning that it has been pressed and what button it

              // fill out the display box with all the data for that event
              var output = "";

              // Get the data that relates to that event name
              var eventData = data[eventName];

              // get the keys for that events data
              var eventKeys = [];

              //output += eventData[1].RunTime + "<br/>"; // test display for getting the runtime of 1 event to check that its actually storing that data


              // get the different event data key names and store in array
              eventData.forEach(ForEachGetEventKeys);
              function ForEachGetEventKeys(item, index){
                // add the key name to the event data key array
                // if its an object, we need to go deeper so call the function again
                if (typeof item === "object" ) {
                  //output += "need to go deeper <br/>"; // debug output
                  Object.keys(item).forEach(ForEachGetEventKeys);
                }
                else { // not an object so add to the event key to the list
                  // check if already in the Array, if it doesnt add it to the array
                  if (!eventKeys.includes(item)) {
                    eventKeys.push(item);
                    //output += item + " has been added to the event keys<br/>"; // debug output
                  }
                }
              }

              // clear all the event data buttons
              if (eventDataButtons.length > 0) {
                eventDataButtons.forEach(ClearAllButtons);
                function ClearAllButtons(item, index){
                  var deleteElem = document.getElementById(item.id);
                  deleteElem.parentNode.removeChild(deleteElem);
                }
              }
              //empty the array of data buttons
              eventDataButtons = [];
              // output the number of entries like a title
              output += "<b>"+ eventName + " has " + eventData.length + " entries</b><br/>";
              // output the entries
              // loop through all the event data entries
              for (var i = 0; i < eventData.length; i++) {

                // output the entry number
                output += "<i>" + "Entry " + i + "</i><br/>";

                // loop through all the event keys and output the data for them
                for (var j = 0; j < eventKeys.length; j++) {

                  // output the name of the key
                  output += "&nbsp" + eventKeys[j] + " : ";
                  // add the value
                  output += eventData[i][eventKeys[j]];
                  // add a new line before moving on
                  output += "<br/>";
                }

              }


              // create a new set of buttons for the different data in the event
              eventKeys.forEach(ForEachEventDataKeyCreateButton);
              function ForEachEventDataKeyCreateButton(item, index){
                CreateButtonForDataSort(item);
              }

              function CreateButtonForDataSort(dataName){
                // create a new button
                var newButton = document.createElement("BUTTON");
                var newButtonText = document.createTextNode(dataName);
                // give the button an id incase we need to access via id at any point
                newButton.id = dataName+"_button";
                // append the text to the button
                newButton.appendChild(newButtonText);
                // append the button to the list of buttons
                document.getElementById("SortButtons").appendChild(newButton);

                eventDataButtons.push(newButton);
                // add an event listener for clicking on the button to display the data for that event type
                newButton.addEventListener("click", function(){SortDataByEventDataKey(dataName);});
              }

              // button calls this and then sorts the data for this event
              function SortDataByEventDataKey(dataName){

                // clear the previously displayed data
                output = "";
                // add a sorted title
                output += "<b>" + "Sorting All " + eventName + " data by " + dataName + "</b><br/>";


                function SortArrayOfObjects(key, order='asc'){
                  return function(a,b){
                    if(!a.hasOwnProperty(key) || !b.hasOwnProperty(key)){
                      return 0;
                    }

                    const varA = (typeof a[key] === 'string') ? a[key].toUpperCase() : a[key];
                    const varB = (typeof b[key] === 'string') ? b[key].toUpperCase() : b[key];

                    let comparison = 0;
                    if (varA > varB) {
                      comparison = 1;
                    }
                    else if( varA < varB){
                      comparison = -1;
                    }
                    return ((order=='desc') ? (comparison * -1) : comparison);
                  };

                }

                //create a copy of the event data so its not adjusted by
                var dataToSort = [];
                for (var i = 0; i < eventData.length; i++) {
                  dataToSort.push(eventData[i]);
                }

                // sort ascending
                dataToSort.sort(SortArrayOfObjects(dataName));
                // sort descending
                //dataToSort.sort(SortArrayOfObjects(dataName, 'desc'));

                // output all the data
                for (var i = 0; i < dataToSort.length; i++) {

                  // output the entry number
                  output += "<i>" + "Sorted by " + dataName + " Entry " + i + "</i><br/>";

                  // loop through all the event keys and output the data for them
                  for (var j = 0; j < eventKeys.length; j++) {

                    // output the name of the key
                    output += "&nbsp" + eventKeys[j] + " : ";
                    // add the value
                    output += dataToSort[i][eventKeys[j]];
                    // add a new line before moving on
                    output += "<br/>";
                  }

                }


                // output the data inside sorted event the event
                document.getElementById("JSONDisplay").innerHTML = output;
              }

              // output the data inside the event
              document.getElementById("JSONDisplay").innerHTML = output;
            }

        },
        error: function(){
          document.getElementById("testDisplay").innerHTML = "failed to retrieve data from './saved/combinedFile.json'<br/>";
        }
    });
  }

  function CombineAndSaveData(){
    $.ajax({
        url: 'CombineAndSaveAllJSONFiles.php',
        success: function (response) {//response is value returned from php
            document.getElementById("JSONDisplay").innerHTML = response;
            document.getElementById("testDisplay").innerHTML = "Combine and Save Complete<br/>";
        },
        error: function(){
          document.getElementById("testDisplay").innerHTML = "failed to Combine and Save Data<br/>";
        }
    });
  }

  function LoadAndOrganise(){
    $.ajax({
        url: 'SortJSONForDisplay.php',
        success: function (response) {//response is value returned from php
            document.getElementById("JSONDisplay").innerHTML = response;
            document.getElementById("testDisplay").innerHTML = "All data loaded and displayed<br/>"
        },
        error: function(){
          document.getElementById("testDisplay").innerHTML = "failed to load data from './saved/combinedFile.json'<br/>";
        }
    });
  }

  function ClearData(){
    document.getElementById("JSONDisplay").innerHTML = "";
    document.getElementById("testDisplay").innerHTML = "data cleared";
    document.getElementById("SortButtons").innerHTML = "";
  }

  function ClearPage(){
    document.getElementById("JSONDisplay").innerHTML = "";
    document.getElementById("testDisplay").innerHTML = "";
    document.getElementById("SortButtons").innerHTML = "";
  }

</script>

</html>
